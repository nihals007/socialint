<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Notice Board</title>
  <meta name="description" content="A simple, dynamic digital notice board for a local community or residential society. Single-file, no backend, stores data locally." />
  <style>
    :root{
      --bg: #0b1020;
      --panel: #121933;
      --muted: #8b95b4;
      --text: #e9edff;
      --brand: #7c9cff;
      --accent: #6af1c2;
      --danger: #ff6b6b;
      --warn: #ffd166;
      --ok: #57e389;
      --card: rgba(255,255,255,.04);
      --card-border: rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      [data-theme="auto"]:root, [data-theme="light"]:root{
        --bg: #f6f8ff;
        --panel: #ffffff;
        --muted: #5b678a;
        --text: #0e1b42;
        --brand: #3451ff;
        --accent: #0aa37f;
        --danger: #cc2f2f;
        --warn: #b28900;
        --ok: #007a4b;
        --card: rgba(0,0,0,.04);
        --card-border: rgba(0,0,0,.08);
        --shadow: 0 10px 30px rgba(0,0,0,.12);
      }
    }
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(124,156,255,.18), transparent 70%),
                  radial-gradient(900px 700px at 120% 10%, rgba(106,241,194,.2), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    /* Layout */
    .wrap{max-width:1150px; margin:0 auto; padding:18px}
    header{position:sticky; top:0; backdrop-filter:saturate(1.1) blur(8px); background:linear-gradient(to bottom, rgba(0,0,0,.35), transparent); z-index:9}
    .bar{display:flex; align-items:center; gap:12px; padding:14px 18px; border-radius:18px; background:var(--panel); box-shadow:var(--shadow); border:1px solid var(--card-border)}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo{width:34px; height:34px; display:grid; place-items:center; border-radius:10px; background:linear-gradient(135deg,var(--brand), var(--accent)); color:#000; font-weight:900}
    .grow{flex:1}
    .search{max-width:380px; flex:1; display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--card-border); padding:8px 12px; border-radius:12px}
    .search input{flex:1; border:0; outline:0; background:transparent; color:var(--text)}
    .nav{display:flex; gap:6px; flex-wrap:wrap}
    .tab-btn{border:1px solid var(--card-border); background:var(--card); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer}
    .tab-btn.active{background:linear-gradient(180deg, rgba(124,156,255,.25), rgba(124,156,255,.12)); border-color:rgba(124,156,255,.45)}
    .chip{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--card-border); background:var(--card); color:var(--muted)}
    .muted{color:var(--muted)}

    main{margin-top:14px}
    .section{display:none}
    .section.active{display:block}

    .grid{display:grid; gap:14px}
    @media (min-width: 850px){ .grid{ grid-template-columns: repeat(12, 1fr);} }
    .col-12{grid-column: span 12}
    .col-8{grid-column: span 12}
    .col-4{grid-column: span 12}
    @media (min-width: 850px){ .col-8{grid-column: span 8} .col-4{grid-column: span 4} }

    .card{background:var(--panel); border:1px solid var(--card-border); border-radius:18px; padding:16px; box-shadow:var(--shadow)}
    .card + .card{margin-top:0}
    .card-title{display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px}
    .tag{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--card-border); background:var(--card)}

    .list{display:grid; gap:12px}
    .item{display:flex; gap:14px; border:1px solid var(--card-border); background:linear-gradient(180deg, rgba(255,255,255,.04), transparent); padding:12px; border-radius:14px; align-items:flex-start; transition:transform .15s ease, background .2s ease}
    .item:hover{transform:translateY(-2px)}
    .item .left{width:52px; min-width:52px; height:52px; border-radius:12px; display:grid; place-items:center; background:var(--card); border:1px solid var(--card-border); font-weight:800}
    .item .body{flex:1}
    .item .title{font-weight:700}
    .item .meta{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button, .btn{cursor:pointer; border:1px solid var(--card-border); background:var(--card); color:var(--text); padding:8px 12px; border-radius:12px}
    .btn.primary{background:linear-gradient(180deg, rgba(124,156,255,.35), rgba(124,156,255,.12)); border-color:rgba(124,156,255,.45)}
    .btn.danger{border-color:rgba(255,107,107,.45); background:linear-gradient(180deg, rgba(255,107,107,.25), rgba(255,107,107,.08))}
    .btn.ghost{background:transparent}

    .kpi{display:flex; gap:10px; align-items:center}
    .kpi .num{font-weight:900; font-size:22px}

    .fab{position:fixed; right:22px; bottom:22px; z-index:10}
    .fab button{padding:14px 18px; font-weight:800; border-radius:16px; box-shadow:var(--shadow); background:linear-gradient(135deg,var(--brand), var(--accent)); color:#021; border:0}

    /* Modal */
    dialog{border:0; border-radius:18px; padding:0; background:var(--panel); color:var(--text); width:min(860px, 92vw)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 18px; border-bottom:1px solid var(--card-border)}
    .modal-body{padding:16px 18px}
    .form{display:grid; gap:10px}
    label{font-size:13px; color:var(--muted)}
    input, select, textarea{width:100%; border:1px solid var(--card-border); background:var(--card); color:var(--text); padding:10px 12px; border-radius:12px; outline:0}
    textarea{min-height:90px; resize:vertical}
    .two{display:grid; gap:10px}
    @media (min-width: 680px){ .two{ grid-template-columns: 1fr 1fr } }
    .admin-hint{font-size:12px; color:var(--muted)}

    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--card-border); background:var(--card)}
    .pill .dot{width:8px; height:8px; border-radius:999px; background:var(--ok)}

    .empty{padding:16px; border:1px dashed var(--card-border); border-radius:14px; color:var(--muted); text-align:center}

    .footer{margin:22px 0; color:var(--muted); font-size:12px; text-align:center}
    a {color: var(--brand); text-decoration: none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="bar">
        <div class="brand" aria-label="Site title">
          <div class="logo" aria-hidden="true">NB</div>
          <div>
            <div>Community Notice Board</div>
            <div class="muted" style="font-size:12px">Simple ‚Ä¢ Offline ‚Ä¢ Low maintenance</div>
          </div>
        </div>
        <div class="grow"></div>
        <div class="search" role="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
          <input id="searchInput" placeholder="Search notices, events, marketplace, contacts‚Ä¶" aria-label="Search" />
        </div>
        <div class="nav" role="tablist" aria-label="Sections">
          <button class="tab-btn active" data-tab="announcements" role="tab" aria-selected="true">Announcements</button>
          <button class="tab-btn" data-tab="events" role="tab">Events</button>
          <button class="tab-btn" data-tab="market" role="tab">Buy/Sell/Rent</button>
          <button class="tab-btn" data-tab="contacts" role="tab">Contacts</button>
        </div>
        <div class="grow"></div>
        <div class="nav">
          <button id="themeToggle" class="tab-btn" title="Toggle theme" aria-label="Toggle theme">üåó</button>
          <button id="adminToggle" class="tab-btn" title="Admin mode" aria-label="Toggle admin mode">üîí Admin</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section id="announcements" class="section active col-8" aria-labelledby="announcements-tab">
        <div class="card">
          <div class="card-title">üì£ Announcements <span class="chip" id="annCount">0</span></div>
          <div class="list" id="annList"></div>
          <div class="empty" id="annEmpty" hidden>No announcements yet.</div>
        </div>
      </section>

      <aside class="col-4">
        <div class="card">
          <div class="card-title">üìÖ Upcoming Events <span class="chip" id="evtCount">0</span></div>
          <div class="list" id="evtList"></div>
          <div class="empty" id="evtEmpty" hidden>No upcoming events.</div>
        </div>
        <div class="card" style="margin-top:14px">
          <div class="card-title">üìá Important Contacts <span class="chip" id="conCount">0</span></div>
          <div class="list" id="conList"></div>
          <div class="empty" id="conEmpty" hidden>No contacts added.</div>
        </div>
        <div class="card" style="margin-top:14px">
          <div class="card-title">üß∞ Tools</div>
          <div class="actions">
            <button class="btn" id="exportBtn">Export Backup</button>
            <label class="btn" for="importFile" style="cursor:pointer">Import</label>
            <input type="file" id="importFile" accept="application/json" hidden />
            <button class="btn ghost" id="resetBtn" title="Reset demo data">Reset</button>
          </div>
          <div class="admin-hint" style="margin-top:8px">Admin PIN <code id="pinShow">(default: 2468)</code></div>
        </div>
      </aside>

      <section id="events" class="section col-12">
        <div class="card">
          <div class="card-title">All Events</div>
          <div class="list" id="evtAll"></div>
        </div>
      </section>

      <section id="market" class="section col-12">
        <div class="card">
          <div class="card-title">üõí Marketplace <span class="tag">Neighbour-to-neighbour only</span></div>
          <div class="actions" style="margin:10px 0">
            <select id="marketFilter">
              <option value="all">All</option>
              <option value="sell">For Sale</option>
              <option value="buy">Wanted</option>
              <option value="rent">Rent</option>
              <option value="giveaway">Giveaway</option>
            </select>
          </div>
          <div class="list" id="mktList"></div>
          <div class="empty" id="mktEmpty" hidden>No listings yet.</div>
        </div>
      </section>

      <section id="contacts" class="section col-12">
        <div class="card">
          <div class="card-title">All Contacts</div>
          <div class="list" id="conAll"></div>
        </div>
      </section>
    </div>
  </main>

  <div class="fab" aria-live="polite">
    <button id="quickPost" title="Quick post" hidden>Ôºã Post</button>
  </div>

  <!-- Admin Modal -->
  <dialog id="adminModal" aria-labelledby="adminTitle">
    <form method="dialog">
      <div class="modal-head">
        <div style="display:flex; align-items:center; gap:10px">
          <div class="pill"><span class="dot" id="adminDot"></span><span id="adminTitle">Admin Panel</span></div>
          <span class="admin-hint">Local only ‚Ä¢ Changes saved to your browser</span>
        </div>
        <div class="actions">
          <button class="btn" value="cancel">Close</button>
        </div>
      </div>
    </form>
    <div class="modal-body">
      <div class="actions" style="margin-bottom:12px; gap:6px">
        <button class="tab-btn" data-admin="add-announce">Add Announcement</button>
        <button class="tab-btn" data-admin="add-event">Add Event</button>
        <button class="tab-btn" data-admin="add-market">Add Marketplace</button>
        <button class="tab-btn" data-admin="add-contact">Add Contact</button>
        <button class="tab-btn" data-admin="settings">Settings</button>
      </div>

      <div id="adminViews">
        <!-- dynamic views injected here -->
      </div>
    </div>
  </dialog>

  <template id="tpl-ann-item">
    <div class="item" data-id="">
      <div class="left">üì£</div>
      <div class="body">
        <div class="title"></div>
        <div class="meta"></div>
        <div class="desc muted" style="margin-top:6px"></div>
        <div class="actions" style="margin-top:8px">
          <button class="btn" data-act="share">Share</button>
          <button class="btn" data-act="pin">Pin</button>
          <button class="btn danger" data-act="del">Delete</button>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-evt-item">
    <div class="item" data-id="">
      <div class="left">üìÖ</div>
      <div class="body">
        <div class="title"></div>
        <div class="meta"></div>
        <div class="desc muted" style="margin-top:6px"></div>
        <div class="actions" style="margin-top:8px">
          <button class="btn" data-act="ics">Add to Calendar</button>
          <button class="btn" data-act="share">Share</button>
          <button class="btn danger" data-act="del">Delete</button>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-mkt-item">
    <div class="item" data-id="">
      <div class="left">üõí</div>
      <div class="body">
        <div class="title"></div>
        <div class="meta"></div>
        <div class="desc muted" style="margin-top:6px"></div>
        <div class="actions" style="margin-top:8px">
          <button class="btn" data-act="share">Share</button>
          <button class="btn danger" data-act="del">Delete</button>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-con-item">
    <div class="item" data-id="">
      <div class="left">‚òéÔ∏è</div>
      <div class="body">
        <div class="title"></div>
        <div class="meta"></div>
        <div class="actions" style="margin-top:8px">
          <a class="btn" data-act="call">Call</a>
          <a class="btn" data-act="mail">Email</a>
          <button class="btn danger" data-act="del">Delete</button>
        </div>
      </div>
    </div>
  </template>

  <footer class="wrap footer">
    Tip: This notice board is a single HTML file. Host it anywhere (even open directly). Data is stored in your browser only. Use Export to share/backup.
  </footer>

  <script>
  // ====== Simple Local Data Store ======
  const STORAGE_KEY = 'communityBoardData.v1';
  const DEFAULT_PIN = '2468'; // Change this!

  const demoData = {
    meta: { pin: DEFAULT_PIN, created: new Date().toISOString(), name: 'Community Notice Board' },
    announcements: [
      { id: uid(), title: 'Water Tank Cleaning', desc: 'Water supply will be affected on Sunday, 10 AM ‚Äì 2 PM. Please store water in advance.', date: todayPlus(0), pinned: true, expires: todayPlus(3) },
      { id: uid(), title: 'Gym Maintenance', desc: 'Treadmills under maintenance this week. Sorry for the inconvenience.', date: todayPlus(0), pinned: false, expires: todayPlus(7) }
    ],
    events: [
      { id: uid(), title: 'Society Cultural Night', desc: 'Open mic, potluck & games at the clubhouse.', start: dateISO(addDays(new Date(), 5), '18:30'), end: dateISO(addDays(new Date(), 5), '21:00'), location: 'Clubhouse Lawn' },
      { id: uid(), title: 'Clean-Up Drive', desc: 'Join us to clean Block B surroundings.', start: dateISO(addDays(new Date(), 2), '08:00'), end: dateISO(addDays(new Date(), 2), '10:30'), location: 'Block B Gate' }
    ],
    market: [
      { id: uid(), type: 'sell', title: 'Study Table - Good Condition', desc: 'Solid wood, 120cm. Pickup only.', price: '‚Çπ2500', contact: 'Rohit (904xx 12345)' },
      { id: uid(), type: 'rent', title: '1BHK for Rent (Block C)', desc: 'Semi-furnished, available from next month.', price: '‚Çπ15k/mo', contact: 'Priya (98xx 56789)' },
      { id: uid(), type: 'giveaway', title: 'Kids story books', desc: 'Free to a good home.', price: 'Free', contact: 'Anita (9xxxx 0000)'}
    ],
    contacts: [
      { id: uid(), name: 'Rakesh Sharma', role: 'Society Manager', phone: '+91 90000 11111', email: 'manager@example.com' },
      { id: uid(), name: 'Security Gate', role: '24x7 Security', phone: '+91 90000 22222', email: 'security@example.com' },
      { id: uid(), name: 'Electrician (Mahesh)', role: 'On-call Repairs', phone: '+91 90000 33333', email: 'electrician@example.com' }
    ]
  };

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ save(demoData); return structuredClone(demoData); }
    try{ return JSON.parse(raw); }catch{ save(demoData); return structuredClone(demoData); }
  }
  function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  function uid(){ return Math.random().toString(36).slice(2, 10); }
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function todayPlus(n){ return addDays(new Date(), n).toISOString().slice(0,10); }
  function dateISO(d, t='00:00'){ const x=new Date(d); const [hh,mm]=t.split(':'); x.setHours(+hh, +mm, 0, 0); return x.toISOString(); }
  function fmtDate(d){ const x=new Date(d); return x.toLocaleString([], { dateStyle:'medium', timeStyle: d.includes('T')? 'short':'short' }); }
  function isPast(d){ return new Date(d) < new Date(); }

  let DB = load();

  // ====== Theming ======
  const root = document.documentElement;
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme') || 'auto';
    const next = cur === 'light' ? 'dark' : cur === 'dark' ? 'auto' : 'light';
    document.documentElement.setAttribute('data-theme', next);
  });

  // ====== Tabs & Routing ======
  const sections = ['announcements','events','market','contacts'];
  const tabButtons = document.querySelectorAll('.tab-btn[data-tab]');
  tabButtons.forEach(btn=>btn.addEventListener('click',()=>goTab(btn.dataset.tab)));
  function goTab(tab){
    sections.forEach(id=>{
      document.getElementById(id).classList.toggle('active', id===tab);
      document.querySelector(`.tab-btn[data-tab="${id}"]`).classList.toggle('active', id===tab);
    });
    location.hash = tab;
    // For accessibility
    const tabBtn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
    tabBtn?.focus();
  }
  window.addEventListener('hashchange', ()=>{
    const t = location.hash.replace('#','');
    if(sections.includes(t)) goTab(t);
  });
  if(location.hash){ const t=location.hash.replace('#',''); if(sections.includes(t)) goTab(t); }

  // ====== Search ======
  const searchInput = document.getElementById('searchInput');
  searchInput.addEventListener('input', renderAll);
  function matchesQuery(text){
    const q = searchInput.value.trim().toLowerCase();
    if(!q) return true;
    return text.toLowerCase().includes(q);
  }

  // ====== Admin Mode ======
  let ADMIN = false;
  const adminToggle = document.getElementById('adminToggle');
  const quickPost = document.getElementById('quickPost');
  const adminModal = document.getElementById('adminModal');
  const adminViews = document.getElementById('adminViews');
  const adminDot = document.getElementById('adminDot');

  function setAdmin(on){
    ADMIN = !!on;
    adminToggle.textContent = ADMIN ? '‚úÖ Admin' : 'üîí Admin';
    quickPost.hidden = !ADMIN;
    adminDot.style.background = ADMIN ? 'var(--ok)' : 'var(--danger)';
  }
  setAdmin(false);

  adminToggle.addEventListener('click', ()=>{
    if(ADMIN){ adminModal.showModal(); renderAdmin('add-announce'); return; }
    const pin = prompt('Enter Admin PIN');
    if(pin && pin === DB.meta.pin){ setAdmin(true); adminModal.showModal(); renderAdmin('add-announce'); }
    else if(pin){ alert('Incorrect PIN'); }
  });
  quickPost.addEventListener('click', ()=>{ adminModal.showModal(); renderAdmin('add-announce'); });

  function renderAdmin(view){
    document.querySelectorAll('[data-admin]').forEach(b=>b.classList.toggle('active', b.dataset.admin===view));
    adminViews.innerHTML = '';
    if(view==='add-announce') adminViews.appendChild(adminAddAnnouncement());
    if(view==='add-event') adminViews.appendChild(adminAddEvent());
    if(view==='add-market') adminViews.appendChild(adminAddMarket());
    if(view==='add-contact') adminViews.appendChild(adminAddContact());
    if(view==='settings') adminViews.appendChild(adminSettings());
  }
  document.querySelectorAll('[data-admin]').forEach(b=>b.addEventListener('click',()=>renderAdmin(b.dataset.admin)));

  function adminAddAnnouncement(){
    const wrap = el('div');
    wrap.innerHTML = `
      <div class="form">
        <div class="two">
          <div><label>Title</label><input id="a-title" placeholder="e.g., Water Tank Cleaning"/></div>
          <div><label>Expires (optional)</label><input id="a-exp" type="date" /></div>
        </div>
        <div><label>Description</label><textarea id="a-desc" placeholder="Details‚Ä¶"></textarea></div>
        <div class="actions">
          <label class="pill"><input type="checkbox" id="a-pin"/> <span>Pin to top</span></label>
          <button class="btn primary" id="a-save">Post Announcement</button>
        </div>
        <hr style="border:none; border-top:1px solid var(--card-border)">
        <div class="admin-hint">Existing Announcements</div>
        <div id="a-list"></div>
      </div>`;
    wrap.querySelector('#a-save').addEventListener('click', ()=>{
      const title = val('#a-title'), desc = val('#a-desc');
      if(!title){ alert('Title required'); return; }
      DB.announcements.unshift({ id: uid(), title, desc, date: new Date().toISOString(), pinned: qs('#a-pin', wrap).checked, expires: val('#a-exp')||null });
      save(DB); renderAll(); alert('Announcement posted');
    });
    // list existing
    const list = el('div'); list.className='list';
    DB.announcements.forEach(a=>{
      const row = el('div'); row.className='item'; row.innerHTML = `<div class="left">üì£</div><div class="body"><div class="title">${esc(a.title)}</div><div class="meta">${a.pinned?'<span class="tag">Pinned</span>':''} Posted ${fmtDate(a.date)}</div></div>`;
      row.addEventListener('click',()=>{
        if(confirm('Delete this announcement?')){ DB.announcements = DB.announcements.filter(x=>x.id!==a.id); save(DB); renderAll(); row.remove(); }
      });
      list.appendChild(row);
    });
    wrap.querySelector('#a-list').appendChild(list);
    return wrap;
  }

  function adminAddEvent(){
    const wrap = el('div');
    wrap.innerHTML = `
      <div class="form">
        <div class="two">
          <div><label>Title</label><input id="e-title" placeholder="e.g., Cultural Night"/></div>
          <div><label>Location</label><input id="e-loc" placeholder="Clubhouse"/></div>
        </div>
        <div class="two">
          <div><label>Start</label><input id="e-start" type="datetime-local"/></div>
          <div><label>End</label><input id="e-end" type="datetime-local"/></div>
        </div>
        <div><label>Description</label><textarea id="e-desc" placeholder="Details‚Ä¶"></textarea></div>
        <div class="actions">
          <button class="btn primary" id="e-save">Add Event</button>
        </div>
        <hr style="border:none; border-top:1px solid var(--card-border)">
        <div class="admin-hint">Upcoming Events</div>
        <div id="e-list"></div>
      </div>`;
    wrap.querySelector('#e-save').addEventListener('click', ()=>{
      const title=val('#e-title'), desc=val('#e-desc'), start=val('#e-start'), end=val('#e-end'), location=val('#e-loc');
      if(!title||!start){ alert('Title and start required'); return; }
      DB.events.push({ id: uid(), title, desc, start: new Date(start).toISOString(), end: end ? new Date(end).toISOString() : new Date(start).toISOString(), location });
      save(DB); renderAll(); alert('Event added');
    });
    const list = el('div'); list.className='list';
    DB.events.sort((a,b)=>new Date(a.start)-new Date(b.start)).forEach(e=>{
      const row = el('div'); row.className='item'; row.innerHTML = `<div class="left">üìÖ</div><div class="body"><div class="title">${esc(e.title)}</div><div class="meta">${fmtDate(e.start)}${e.location? ' ‚Ä¢ '+esc(e.location):''}</div></div>`;
      row.addEventListener('click',()=>{
        if(confirm('Delete this event?')){ DB.events = DB.events.filter(x=>x.id!==e.id); save(DB); renderAll(); row.remove(); }
      });
      list.appendChild(row);
    });
    wrap.querySelector('#e-list').appendChild(list);
    return wrap;
  }

  function adminAddMarket(){
    const wrap = el('div');
    wrap.innerHTML = `
      <div class="form">
        <div class="two">
          <div>
            <label>Type</label>
            <select id="m-type">
              <option value="sell">For Sale</option>
              <option value="buy">Wanted</option>
              <option value="rent">Rent</option>
              <option value="giveaway">Giveaway</option>
            </select>
          </div>
          <div><label>Title</label><input id="m-title" placeholder="e.g., Cycle for sale"/></div>
        </div>
        <div><label>Description</label><textarea id="m-desc" placeholder="Details‚Ä¶"></textarea></div>
        <div class="two">
          <div><label>Price</label><input id="m-price" placeholder="e.g., ‚Çπ1200 / ‚Çπ15k/mo / Free"/></div>
          <div><label>Contact</label><input id="m-contact" placeholder="Name & phone"/></div>
        </div>
        <div class="actions">
          <button class="btn primary" id="m-save">Add Listing</button>
        </div>
        <hr style="border:none; border-top:1px solid var(--card-border)">
        <div class="admin-hint">All Listings</div>
        <div id="m-list"></div>
      </div>`;
    wrap.querySelector('#m-save').addEventListener('click', ()=>{
      const type=val('#m-type'), title=val('#m-title');
      if(!title){ alert('Title required'); return; }
      DB.market.unshift({ id: uid(), type, title, desc: val('#m-desc'), price: val('#m-price'), contact: val('#m-contact') });
      save(DB); renderAll(); alert('Listing added');
    });
    const list = el('div'); list.className='list';
    DB.market.forEach(m=>{
      const row = el('div'); row.className='item'; row.innerHTML = `<div class="left">üõí</div><div class="body"><div class="title">${esc(m.title)} <span class="tag">${m.type}</span></div><div class="meta">${esc(m.price||'')}</div></div>`;
      row.addEventListener('click',()=>{
        if(confirm('Delete this listing?')){ DB.market = DB.market.filter(x=>x.id!==m.id); save(DB); renderAll(); row.remove(); }
      });
      list.appendChild(row);
    });
    wrap.querySelector('#m-list').appendChild(list);
    return wrap;
  }

  function adminAddContact(){
    const wrap = el('div');
    wrap.innerHTML = `
      <div class="form">
        <div class="two">
          <div><label>Name</label><input id="c-name" placeholder="e.g., Society Manager"/></div>
          <div><label>Role</label><input id="c-role" placeholder="Role/Dept"/></div>
        </div>
        <div class="two">
          <div><label>Phone</label><input id="c-phone" placeholder="Phone"/></div>
          <div><label>Email</label><input id="c-email" placeholder="Email"/></div>
        </div>
        <div class="actions">
          <button class="btn primary" id="c-save">Add Contact</button>
        </div>
        <hr style="border:none; border-top:1px solid var(--card-border)">
        <div class="admin-hint">All Contacts</div>
        <div id="c-list"></div>
      </div>`;
    wrap.querySelector('#c-save').addEventListener('click', ()=>{
      const name=val('#c-name'); if(!name){ alert('Name required'); return; }
      DB.contacts.push({ id: uid(), name, role: val('#c-role'), phone: val('#c-phone'), email: val('#c-email') });
      save(DB); renderAll(); alert('Contact added');
    });
    const list = el('div'); list.className='list';
    DB.contacts.forEach(c=>{
      const row = el('div'); row.className='item'; row.innerHTML = `<div class="left">‚òéÔ∏è</div><div class="body"><div class="title">${esc(c.name)}</div><div class="meta">${esc(c.role||'')}</div></div>`;
      row.addEventListener('click',()=>{
        if(confirm('Delete this contact?')){ DB.contacts = DB.contacts.filter(x=>x.id!==c.id); save(DB); renderAll(); row.remove(); }
      });
      list.appendChild(row);
    });
    wrap.querySelector('#c-list').appendChild(list);
    return wrap;
  }

  function adminSettings(){
    const wrap = el('div');
    wrap.innerHTML = `
      <div class="form">
        <div class="two">
          <div><label>Board Name</label><input id="s-name"/></div>
          <div><label>Admin PIN</label><input id="s-pin" placeholder="Change PIN"/></div>
        </div>
        <div class="actions">
          <button class="btn primary" id="s-save">Save Settings</button>
          <button class="btn danger" id="s-logout">Exit Admin</button>
        </div>
      </div>`;
    wrap.querySelector('#s-name').value = DB.meta.name || 'Community Notice Board';
    wrap.querySelector('#s-pin').value = DB.meta.pin;
    wrap.querySelector('#s-save').addEventListener('click', ()=>{
      DB.meta.name = val('#s-name');
      DB.meta.pin = val('#s-pin') || DB.meta.pin; 
      save(DB); document.title = DB.meta.name; document.querySelector('.brand div:first-child + div div:first-child').textContent = DB.meta.name; document.getElementById('pinShow').textContent = `(PIN: ${DB.meta.pin})`; alert('Saved');
    });
    wrap.querySelector('#s-logout').addEventListener('click', ()=>{ setAdmin(false); adminModal.close(); });
    return wrap;
  }

  // ====== Renderers ======
  function renderAll(){
    // Announcements
    const annMount = document.getElementById('annList'); annMount.innerHTML='';
    let anns = DB.announcements.filter(a=>!a.expires || !isPast(a.expires));
    const q = searchInput.value.trim().toLowerCase();
    if(q) anns = anns.filter(a=>`${a.title} ${a.desc}`.toLowerCase().includes(q));
    anns.sort((a,b)=> (b.pinned-a.pinned) || new Date(b.date)-new Date(a.date));
    document.getElementById('annCount').textContent = anns.length;
    if(anns.length===0) document.getElementById('annEmpty').hidden=false; else document.getElementById('annEmpty').hidden=true;
    anns.forEach(a=>annMount.appendChild(renderAnn(a)));

    // Events (sidebar)
    const up = DB.events.filter(e=> new Date(e.end||e.start) >= new Date()).sort((a,b)=> new Date(a.start)-new Date(b.start));
    document.getElementById('evtCount').textContent = up.length;
    const eList = document.getElementById('evtList'); eList.innerHTML='';
    if(up.length===0) document.getElementById('evtEmpty').hidden=false; else document.getElementById('evtEmpty').hidden=true;
    up.slice(0,5).forEach(e=> eList.appendChild(renderEvt(e)));

    // Events (page)
    const eAll = document.getElementById('evtAll'); eAll.innerHTML='';
    up.forEach(e=> eAll.appendChild(renderEvt(e)));

    // Marketplace
    const mList = document.getElementById('mktList'); mList.innerHTML='';
    const filter = document.getElementById('marketFilter').value;
    let mData = DB.market;
    if(filter!=='all') mData = mData.filter(m=>m.type===filter);
    if(q) mData = mData.filter(m=>`${m.title} ${m.desc} ${m.price} ${m.contact}`.toLowerCase().includes(q));
    if(mData.length===0) document.getElementById('mktEmpty').hidden=false; else document.getElementById('mktEmpty').hidden=true;
    mData.forEach(m=> mList.appendChild(renderMkt(m)));

    // Contacts
    const cList = document.getElementById('conList'); cList.innerHTML='';
    const cAll = document.getElementById('conAll'); cAll.innerHTML='';
    let cData = DB.contacts;
    if(q) cData = cData.filter(c=>`${c.name} ${c.role} ${c.phone} ${c.email}`.toLowerCase().includes(q));
    document.getElementById('conCount').textContent = cData.length;
    if(cData.length===0) document.getElementById('conEmpty').hidden=false; else document.getElementById('conEmpty').hidden=true;
    cData.slice(0,5).forEach(c=> cList.appendChild(renderCon(c)));
    cData.forEach(c=> cAll.appendChild(renderCon(c)));
  }

  function renderAnn(a){
    const t = document.getElementById('tpl-ann-item');
    const node = t.content.firstElementChild.cloneNode(true);
    node.dataset.id = a.id;
    node.querySelector('.title').innerHTML = esc(a.title) + (a.pinned? ` <span class="tag">Pinned</span>` : '');
    node.querySelector('.meta').textContent = `Posted ${fmtDate(a.date)}${a.expires? ' ‚Ä¢ Expires '+fmtDate(a.expires):''}`;
    node.querySelector('.desc').textContent = a.desc||'';
    node.querySelector('[data-act="share"]').addEventListener('click',()=>shareText(`${a.title}\n${a.desc||''}`));
    node.querySelector('[data-act="pin"]').addEventListener('click',()=>{ a.pinned=!a.pinned; save(DB); renderAll(); });
    node.querySelector('[data-act="del"]').addEventListener('click',()=>delItem('announcements', a.id));
    return node;
  }
  function renderEvt(e){
    const t = document.getElementById('tpl-evt-item');
    const node = t.content.firstElementChild.cloneNode(true);
    node.dataset.id = e.id;
    node.querySelector('.title').textContent = e.title;
    node.querySelector('.meta').textContent = `${fmtDate(e.start)}${e.end? ' ‚Äì '+fmtDate(e.end):''}${e.location? ' ‚Ä¢ '+e.location:''}`;
    node.querySelector('.desc').textContent = e.desc||'';
    node.querySelector('[data-act="ics"]').addEventListener('click',()=>downloadICS(e));
    node.querySelector('[data-act="share"]').addEventListener('click',()=>shareText(`${e.title} @ ${fmtDate(e.start)}${e.location? ' ‚Ä¢ '+e.location:''}`));
    node.querySelector('[data-act="del"]').addEventListener('click',()=>delItem('events', e.id));
    return node;
  }
  function renderMkt(m){
    const t = document.getElementById('tpl-mkt-item');
    const node = t.content.firstElementChild.cloneNode(true);
    node.dataset.id = m.id;
    node.querySelector('.title').innerHTML = `${esc(m.title)} <span class="tag">${m.type}</span>`;
    node.querySelector('.meta').textContent = `${m.price||''}${m.contact? ' ‚Ä¢ '+m.contact:''}`;
    node.querySelector('.desc').textContent = m.desc||'';
    node.querySelector('[data-act="share"]').addEventListener('click',()=>shareText(`${m.type.toUpperCase()}: ${m.title} ${m.price? '('+m.price+')':''}\n${m.desc||''}\nContact: ${m.contact||''}`));
    node.querySelector('[data-act="del"]').addEventListener('click',()=>delItem('market', m.id));
    return node;
  }
  function renderCon(c){
    const t = document.getElementById('tpl-con-item');
    const node = t.content.firstElementChild.cloneNode(true);
    node.dataset.id = c.id;
    node.querySelector('.title').textContent = c.name;
    node.querySelector('.meta').textContent = `${c.role||''}${c.phone? ' ‚Ä¢ '+c.phone:''}${c.email? ' ‚Ä¢ '+c.email:''}`;
    const tel = `tel:${(c.phone||'').replace(/\s/g,'')}`; const mail=`mailto:${c.email||''}`;
    node.querySelector('[data-act="call"]').href = tel;
    node.querySelector('[data-act="mail"]').href = mail;
    node.querySelector('[data-act="del"]').addEventListener('click',()=>delItem('contacts', c.id));
    return node;
  }

  function delItem(collection, id){
    if(!ADMIN){ alert('Admin only'); return; }
    if(confirm('Delete item?')){
      DB[collection] = DB[collection].filter(x=>x.id!==id);
      save(DB); renderAll();
    }
  }

  // ====== Utilities ======
  function qs(sel, parent=document){ return parent.querySelector(sel); }
  function val(sel, parent=document){ return qs(sel,parent)?.value?.trim?.() || ''; }
  function el(tag){ return document.createElement(tag); }
  function esc(str=''){ return String(str).replace(/[&<>]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s])); }
  function shareText(text){
    if(navigator.share){ navigator.share({ text }).catch(()=>copy(text)); }
    else copy(text);
  }
  function copy(text){ navigator.clipboard?.writeText(text); alert('Copied to clipboard'); }

  function downloadICS(e){
    const dt = (d)=> new Date(d).toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
    const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Community Notice Board//EN\nBEGIN:VEVENT\nUID:${e.id}@local\nDTSTAMP:${dt(new Date())}\nDTSTART:${dt(e.start)}\nDTEND:${dt(e.end||e.start)}\nSUMMARY:${e.title.replace(/\n/g,' ')}\nLOCATION:${(e.location||'').replace(/\n/g,' ')}\nDESCRIPTION:${(e.desc||'').replace(/\n/g,' ')}\nEND:VEVENT\nEND:VCALENDAR`;
    const blob = new Blob([ics], {type:'text/calendar'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${e.title.replace(/[^a-z0-9]/gi,'_')}.ics`; a.click(); URL.revokeObjectURL(a.href);
  }

  // ====== Tools: Export/Import/Reset ======
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(DB, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'notice-board-backup.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  document.getElementById('importFile').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const r = new FileReader(); r.onload = ()=>{ try{ DB = JSON.parse(r.result); save(DB); renderAll(); alert('Imported'); }catch{ alert('Invalid file'); } };
    r.readAsText(file);
  });
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(confirm('Reset to demo data? This replaces current data on this browser.')){ DB = structuredClone(demoData); save(DB); renderAll(); }
  });

  // Filter change
  document.getElementById('marketFilter').addEventListener('change', renderAll);

  // Init
  document.title = DB.meta.name || 'Community Notice Board';
  document.querySelector('.brand div:first-child + div div:first-child').textContent = DB.meta.name || 'Community Notice Board';
  document.getElementById('pinShow').textContent = `(PIN: ${DB.meta.pin})`;
  renderAll();
  </script>
</body>
</html>
